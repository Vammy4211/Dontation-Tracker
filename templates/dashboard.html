{% extends "base.html" %}

{% block title %}Dashboard - Online Donation Tracker{% endblock %}

{% block content %}
<div class="container-fluid px-4" style="max-width: 1400px; margin: 0 auto;">
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-tachometer-alt"></i> Your Dashboard</h1>
        <p class="text-muted">Welcome back, {{ user.username }}!</p>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-heart fa-2x mb-2"></i>
                <h4>${{ "%.2f"|format(donations|sum(attribute='amount') or 0) }}</h4>
                <p class="mb-0">Total Donated</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-hand-holding-heart fa-2x mb-2"></i>
                <h4>{{ donations|length }}</h4>
                <p class="mb-0">Donations Made</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-bullhorn fa-2x mb-2"></i>
                <h4>{{ campaigns|length }}</h4>
                <p class="mb-0">Campaigns Created</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <h4>${{ "%.0f"|format(campaigns|sum(attribute='current_amount') or 0) }}</h4>
                <p class="mb-0">Campaign Funds</p>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="donations-tab" data-bs-toggle="tab" data-bs-target="#donations" type="button">
            <i class="fas fa-heart"></i> My Donations
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="campaigns-tab" data-bs-toggle="tab" data-bs-target="#campaigns" type="button">
            <i class="fas fa-bullhorn"></i> My Campaigns
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button">
            <i class="fas fa-user"></i> Profile
        </button>
    </li>
</ul>

<div class="tab-content mt-4" id="dashboardTabsContent">
    <!-- Donations Tab -->
    <div class="tab-pane fade show active" id="donations" role="tabpanel">
        {% if donations %}
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-heart"></i> Your Donation History</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Campaign</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Message</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for donation in donations %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('campaign_detail', campaign_id=donation.campaign._id) }}" class="text-decoration-none">
                                        {{ donation.campaign.title }}
                                    </a>
                                </td>
                                <td class="fw-bold text-success">${{ "%.2f"|format(donation.amount) }}</td>
                                <td>{{ donation.created_at.strftime('%b %d, %Y') }}</td>
                                <td>
                                    {% if donation.message %}
                                        <span class="text-muted">{{ donation.message[:50] }}{% if donation.message|length > 50 %}...{% endif %}</span>
                                    {% else %}
                                        <em class="text-muted">No message</em>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if donation.is_anonymous %}
                                        <span class="badge bg-secondary">Anonymous</span>
                                    {% else %}
                                        <span class="badge bg-primary">Public</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info text-center">
            <h4><i class="fas fa-info-circle"></i> No donations yet</h4>
            <p>You haven't made any donations yet. Start supporting causes you care about!</p>
            <a href="{{ url_for('campaigns_page') }}" class="btn btn-primary">Browse Campaigns</a>
        </div>
        {% endif %}
    </div>

    <!-- Campaigns Tab -->
    <div class="tab-pane fade" id="campaigns" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="fas fa-bullhorn"></i> Your Campaigns</h5>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createCampaignModal">
                <i class="fas fa-plus"></i> Create New Campaign
            </button>
        </div>

        {% if campaigns %}
        <div class="row">
            {% for campaign in campaigns %}
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title">{{ campaign.title }}</h6>
                            {% if campaign.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </div>
                        
                        <p class="card-text text-muted">{{ campaign.description[:80] }}{% if campaign.description|length > 80 %}...{% endif %}</p>
                        
                        <!-- Progress -->
                        <div class="mb-2">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted">Progress</small>
                                <small class="text-muted">${{ "%.0f"|format(campaign.current_amount) }} / ${{ "%.0f"|format(campaign.goal_amount) }}</small>
                            </div>
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar" style="width: {{ campaign.progress_percentage }}%"></div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">{{ campaign.donations|length }} donors</small>
                            <a href="{{ url_for('campaign_detail', campaign_id=campaign._id) }}" class="btn btn-sm btn-outline-primary">View</a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info text-center">
            <h4><i class="fas fa-info-circle"></i> No campaigns created</h4>
            <p>You haven't created any campaigns yet. Start a campaign to raise funds for your cause!</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCampaignModal">
                <i class="fas fa-plus"></i> Create Your First Campaign
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Profile Tab -->
    <div class="tab-pane fade" id="profile" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-user"></i> Profile Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Username</label>
                            <p class="text-muted">{{ user.username }}</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Email</label>
                            <p class="text-muted">{{ user.email }}</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Member Since</label>
                            <p class="text-muted">{{ user.created_at.strftime('%B %d, %Y') }}</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Account Type</label>
                            <p class="text-muted">
                                {% if user.is_admin %}
                                    <span class="badge bg-warning">Administrator</span>
                                {% else %}
                                    <span class="badge bg-primary">Standard User</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie"></i> Your Impact</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center">
                            <div class="row">
                                <div class="col-6">
                                    <h3 class="text-primary">${{ "%.2f"|format(donations|sum(attribute='amount') or 0) }}</h3>
                                    <p class="text-muted">Total Donated</p>
                                </div>
                                <div class="col-6">
                                    <h3 class="text-success">{{ donations|length }}</h3>
                                    <p class="text-muted">Donations Made</p>
                                </div>
                                <div class="col-6">
                                    <h3 class="text-info">{{ campaigns|length }}</h3>
                                    <p class="text-muted">Campaigns Created</p>
                                </div>
                                <div class="col-6">
                                    {% set total_donors = 0 %}
                                    {% for campaign in campaigns %}
                                        {% set total_donors = total_donors + campaign.donations|length %}
                                    {% endfor %}
                                    <h3 class="text-warning">{{ total_donors }}</h3>
                                    <p class="text-muted">People Helped</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Campaign Modal -->
<div class="modal fade" id="createCampaignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Campaign</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createCampaignForm">
                    <div class="mb-3">
                        <label for="campaignTitle" class="form-label">Campaign Title</label>
                        <input type="text" class="form-control" id="campaignTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="campaignDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="campaignDescription" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="goalAmount" class="form-label">Goal Amount ($)</label>
                        <input type="number" class="form-control" id="goalAmount" min="1" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="endDate" class="form-label">End Date (Optional)</label>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createCampaign()">Create Campaign</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function createCampaign() {
    const title = document.getElementById('campaignTitle').value;
    const description = document.getElementById('campaignDescription').value;
    const goalAmount = document.getElementById('goalAmount').value;
    const endDate = document.getElementById('endDate').value;

    fetch('/api/campaigns', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: title,
            description: description,
            goal_amount: parseFloat(goalAmount),
            end_date: endDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert('Campaign created successfully!');
            location.reload();
        } else {
            alert(data.error || 'An error occurred');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating the campaign');
    });
}
</script>
</div>
{% endblock %}