{% extends "base.html" %}

{% block title %}{{ campaign.title }} - Campaign Details{% endblock %}

{% block content %}
<div class="container-fluid px-4" style="max-width: 1400px; margin: 0 auto;">
<div class="row">
    <!-- Campaign Details -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-body">
                <h1 class="card-title">{{ campaign.title }}</h1>
                <p class="text-muted mb-3">
                    <i class="fas fa-user"></i> Created by {{ campaign.creator.username }} 
                    <span class="ms-3"><i class="fas fa-calendar"></i> {{ campaign.created_at.strftime('%B %d, %Y') }}</span>
                </p>
                
                <!-- Progress Section -->
                <div class="row text-center mb-4">
                    <div class="col-md-3">
                        <h4 class="text-primary">${{ "%.0f"|format(campaign.current_amount) }}</h4>
                        <small class="text-muted">Raised</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-success">${{ "%.0f"|format(campaign.goal_amount) }}</h4>
                        <small class="text-muted">Goal</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-info">{{ "%.1f"|format(campaign.progress_percentage) }}%</h4>
                        <small class="text-muted">Funded</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-warning">{{ campaign.donations|length }}</h4>
                        <small class="text-muted">Backers</small>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="progress mb-4" style="height: 15px;">
                    <div class="progress-bar bg-gradient" style="width: {{ campaign.progress_percentage }}%"></div>
                </div>
                
                <!-- Campaign Description -->
                <div class="mb-4">
                    <h5>About This Campaign</h5>
                    <p class="lead">{{ campaign.description }}</p>
                </div>
                
                <!-- Campaign Status -->
                {% if campaign.is_active %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> This campaign is currently active and accepting donations.
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-pause-circle"></i> This campaign is currently inactive.
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Recent Donations -->
        <div class="card shadow-sm mt-4">
            <div class="card-header">
                <h5><i class="fas fa-heart"></i> Recent Donations</h5>
            </div>
            <div class="card-body">
                {% if donations %}
                <div class="list-group list-group-flush">
                    {% for donation in donations %}
                    <div class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold">
                                {% if donation.is_anonymous %}
                                    <i class="fas fa-user-secret"></i> Anonymous
                                {% else %}
                                    <i class="fas fa-user"></i> {{ donation.donor.username }}
                                {% endif %}
                            </div>
                            {% if donation.message %}
                            <p class="mb-1 text-muted">"{{ donation.message }}"</p>
                            {% endif %}
                            <small class="text-muted">{{ donation.created_at.strftime('%B %d, %Y at %I:%M %p') }}</small>
                        </div>
                        <span class="badge bg-primary rounded-pill">${{ "%.2f"|format(donation.amount) }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center">No donations yet. Be the first to support this campaign!</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Donation Form Sidebar -->
    <div class="col-lg-4">
        {% if session.user_id and campaign.is_active %}
        <div class="donation-form sticky-top">
            <h4 class="text-center mb-4"><i class="fas fa-heart text-danger"></i> Make a Donation</h4>
            
            <form id="donationForm">
                <div class="mb-3">
                    <label for="donationAmount" class="form-label">Donation Amount ($)</label>
                    <input type="number" class="form-control" id="donationAmount" min="1" step="0.01" required>
                </div>
                
                <!-- Quick Amount Buttons -->
                <div class="mb-3">
                    <div class="btn-group d-grid gap-2 d-md-flex justify-content-center" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="setAmount(10)">$10</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="setAmount(25)">$25</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="setAmount(50)">$50</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="setAmount(100)">$100</button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="donationMessage" class="form-label">Message (Optional)</label>
                    <textarea class="form-control" id="donationMessage" rows="3" placeholder="Share why you're supporting this cause..."></textarea>
                </div>
                
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="isAnonymous">
                    <label class="form-check-label" for="isAnonymous">
                        Donate anonymously
                    </label>
                </div>
                
                <div class="d-grid">
                    <button type="button" class="btn btn-success btn-lg" onclick="makeDonation('{{ campaign._id }}')">
                        <i class="fas fa-heart"></i> Donate Now
                    </button>
                </div>
            </form>
            
            <div class="text-center mt-3">
                <small class="text-muted">
                    <i class="fas fa-shield-alt"></i> Secure donation powered by SSL encryption
                </small>
            </div>
        </div>
        {% elif not session.user_id %}
        <div class="donation-form text-center">
            <h4><i class="fas fa-heart text-danger"></i> Support This Campaign</h4>
            <p class="text-muted">Join our community to make a donation</p>
            <div class="d-grid gap-2">
                <a href="{{ url_for('login') }}" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Login to Donate
                </a>
                <a href="{{ url_for('register') }}" class="btn btn-outline-primary">
                    <i class="fas fa-user-plus"></i> Register Account
                </a>
            </div>
        </div>
        {% else %}
        <div class="donation-form text-center">
            <h4><i class="fas fa-pause-circle text-warning"></i> Campaign Inactive</h4>
            <p class="text-muted">This campaign is currently not accepting donations.</p>
        </div>
        {% endif %}
        
        <!-- Campaign Stats -->
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="fas fa-chart-line"></i> Campaign Statistics</h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Days Active:</span>
                    <strong>{{ (moment().now() - campaign.created_at).days + 1 }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Total Donors:</span>
                    <strong>{{ campaign.donations|length }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Average Donation:</span>
                    <strong>
                        {% if campaign.donations|length > 0 %}
                            ${{ "%.2f"|format(campaign.current_amount / campaign.donations|length) }}
                        {% else %}
                            $0.00
                        {% endif %}
                    </strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Completion:</span>
                    <strong>{{ "%.1f"|format(campaign.progress_percentage) }}%</strong>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function setAmount(amount) {
    document.getElementById('donationAmount').value = amount;
}

// Override the global makeDonation function for this page
function makeDonation(campaignId) {
    const amount = document.getElementById('donationAmount').value;
    const message = document.getElementById('donationMessage').value;
    const isAnonymous = document.getElementById('isAnonymous').checked;

    if (!amount || amount <= 0) {
        alert('Please enter a valid donation amount');
        return;
    }

    fetch('/api/donate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            campaign_id: campaignId,
            amount: parseFloat(amount),
            message: message,
            is_anonymous: isAnonymous
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert('Thank you for your generous donation! 🎉');
            location.reload();
        } else {
            alert(data.error || 'An error occurred while processing your donation');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your donation');
    });
}
</script>
</div>
{% endblock %}